# LastCall.jl プロジェクト進行状況

最終更新: 2025年1月

## プロジェクト概要

LastCall.jlは、JuliaからRustコードを直接呼び出すためのFFI（Foreign Function Interface）パッケージです。Cxx.jlを参考に、RustとJuliaの相互運用性を実現します。

## 現在のフェーズ

**Phase 1: C互換ABI統合** (進行中)

- 目標: `extern "C"`を使った基本的なRust-Julia連携
- 実装アプローチ: 共有ライブラリ（`.so`/`.dylib`/`.dll`）経由の`ccall`
- 進捗: **基本機能実装完了** ✅

## 実装状況

### ✅ 実装済み機能

#### 1. プロジェクト基盤
- [x] プロジェクト構造のセットアップ
- [x] `Project.toml`の設定（LLVM.jl依存関係）
- [x] モジュール構造の構築
- [x] ビルドスクリプト（`deps/build.jl`）

#### 2. 型システム
- [x] 基本型マッピング（`i32` ↔ `Int32`, `f64` ↔ `Float64`等）
- [x] ポインタ型のサポート（`*const T`, `*mut T` → `Ptr{T}`）
- [x] `RustResult<T, E>`型の実装
- [x] `RustOption<T>`型の実装
- [x] 型変換関数（`rusttype_to_julia`, `juliatype_to_rust`）

#### 3. Rustコンパイラ統合
- [x] `rustc`ラッパー（`compiler.jl`）
- [x] LLVM IR生成（`--emit llvm-ir`）
- [x] 共有ライブラリ生成（`--crate-type cdylib`）
- [x] プラットフォーム別ターゲット検出
- [x] コンパイルオプション設定（最適化レベル、デバッグ情報）

#### 4. LLVM統合（基本）
- [x] LLVM.jlによるIR読み込み
- [x] 関数シグネチャの取得
- [x] LLVM型からJulia型への変換
- [x] RustModule管理

#### 5. `rust""` 文字列リテラル
- [x] Rustコードのコンパイルとロード
- [x] ライブラリ管理（複数ライブラリのサポート）
- [x] 関数ポインタのキャッシング
- [x] LLVM IR分析（オプション）

#### 6. `@rust` マクロ
- [x] 基本的な関数呼び出し
- [x] 明示的な戻り値型指定（`@rust func(args...)::Type`）
- [x] ライブラリ修飾呼び出し（`@rust lib::func(args...)`）
- [x] 型推論（引数の型から戻り値型を推論）

#### 7. `@irust` マクロ（関数スコープ実行）
- [x] 基本的な実装
- [x] 引数の明示的受け渡し
- [x] 型推論（引数の型から戻り値型を推論）
- [x] コンパイル済み関数のキャッシング

#### 8. コード生成
- [x] `ccall`式の生成
- [x] 型に応じた専用関数（Int32, Int64, Float32, Float64, Bool, Cvoid, UInt32）
- [x] 文字列型のサポート（String引数、Cstring引数）
- [x] 動的ディスパッチ

#### 9. テストスイート
- [x] 型マッピングテスト（23テスト - 文字列型含む）
- [x] RustResult/Optionテスト（16テスト）
- [x] 文字列変換テスト（4テスト）
- [x] コンパイラ設定テスト（6テスト）
- [x] Rustコンパイルテスト（4テスト）
- [x] `@irust`テスト（3テスト）
- [x] 文字列引数テスト（3テスト）
- [x] ライブラリ管理テスト（1テスト）
- **合計: 60テスト、すべてパス** ✅

#### 10. ドキュメント
- [x] README.md（プロジェクト説明、使用例）
- [x] 設計ドキュメント（Phase1.md, Phase2.md等）

### ⏳ 未実装・部分実装機能

#### Phase 1 の残りタスク

1. **`irust""` の改善**
   - [ ] Julia変数の自動バインディング（`$var`構文）
   - [ ] より高度な型推論
   - [ ] エラーメッセージの改善

2. **Result型のエラーハンドリング**
   - [ ] `Result<T, E>`からJulia例外への自動変換
   - [ ] エラーメッセージの詳細化
   - [ ] エラー型のマッピング

3. **文字列型のサポート** ✅
   - [x] C文字列（`*const u8`）入力のサポート
   - [x] Juliaの`String`引数の自動変換
   - [x] `RustString`, `RustStr`型の定義
   - [x] 型マッピング（`String` ↔ `*const u8`）
   - [ ] Rust `String`戻り値の完全サポート（メモリ管理）

4. **配列・コレクション型**
   - [ ] `Vec<T>`のサポート
   - [ ] スライス（`&[T]`）のサポート
   - [ ] メモリ管理の統合

5. **エラーハンドリングの強化**
   - [ ] コンパイルエラーの詳細表示
   - [ ] 実行時エラーの詳細表示
   - [ ] デバッグモード

### 🔮 Phase 2 の計画（未着手）

1. **LLVM IR統合の本格化**
   - [ ] `llvmcall`への直接埋め込み
   - [ ] LLVM IR最適化パスの適用
   - [ ] インライン化の最適化

2. **所有権型のサポート**
   - [ ] `Box<T>`のサポート
   - [ ] `Rc<T>`のサポート
   - [ ] `Arc<T>`のサポート
   - [ ] メモリ管理の統合

3. **ジェネリクス対応**
   - [ ] 単相化（monomorphization）
   - [ ] 型パラメータの推論

4. **高度な型システム**
   - [ ] Lifetimeの基本サポート
   - [ ] Traitの基本サポート

## ファイル構成

```
LastCall.jl/
├── Project.toml          # ✅ 依存関係設定済み
├── README.md              # ✅ プロジェクト説明
├── src/
│   ├── LastCall.jl       # ✅ メインモジュール
│   ├── types.jl          # ✅ Rust型のJulia表現
│   ├── typetranslation.jl # ✅ 型変換ロジック
│   ├── compiler.jl       # ✅ rustcラッパー
│   ├── llvmintegration.jl # ✅ LLVM.jl統合（基本）
│   ├── codegen.jl        # ✅ ccall生成ロジック
│   ├── rustmacro.jl      # ✅ @rustマクロ
│   └── ruststr.jl        # ✅ rust""と@irust実装
├── test/
│   └── runtests.jl       # ✅ 45テスト（全パス）
├── deps/
│   └── build.jl          # ✅ ビルドスクリプト
└── docs/
    ├── design/           # ✅ 設計ドキュメント
    │   ├── Phase1.md
    │   ├── Phase2.md
    │   ├── INTERNAL.md
    │   └── ...
    └── STATUS.md         # ✅ このファイル
```

## テスト状況

### テストカバレッジ

| カテゴリ | テスト数 | ステータス |
|---------|---------|-----------|
| 型マッピング | 23 | ✅ 全パス |
| RustResult | 8 | ✅ 全パス |
| RustOption | 8 | ✅ 全パス |
| 文字列変換 | 4 | ✅ 全パス |
| コンパイラ設定 | 6 | ✅ 全パス |
| Rustコンパイル | 4 | ✅ 全パス |
| `@irust` | 3 | ✅ 全パス |
| 文字列引数 | 3 | ✅ 全パス |
| ライブラリ管理 | 1 | ✅ 全パス |
| **合計** | **60** | **✅ 全パス** |

### テスト実行コマンド

```bash
julia --project -e 'using Pkg; Pkg.test()'
```

**最新結果**: 60テスト、すべてパス ✅

## 既知の制限事項

### Phase 1 の制限

1. **型システム**
   - `extern "C"`関数のみサポート
   - ジェネリクス非対応
   - Lifetime非対応
   - Trait非対応

2. **`@irust`マクロ**
   - 引数は明示的に渡す必要がある（`@irust("code", args...)`）
   - Julia変数の自動バインディング（`$var`構文）は未実装
   - 戻り値型は引数の型から推論（簡易的）

3. **メモリ管理**
   - 所有権システムの詳細な管理は未実装
   - `Box<T>`, `Rc<T>`, `Arc<T>`は未サポート

4. **エラーハンドリング**
   - Rustの`Result<T, E>`からJulia例外への自動変換は未実装
   - エラーメッセージは基本的なもののみ

5. **文字列・配列**
   - C文字列（`*const u8`）入力はサポート済み ✅
   - Rust `String`戻り値のメモリ管理は未実装
   - `Vec<T>`は未サポート

### 技術的制約

1. **ccallの制約**
   - Juliaの`ccall`はリテラル型タプルを要求
   - 動的な型タプル生成が困難
   - 解決策: 型ごとに専用関数を定義

2. **rustc API**
   - rustcの内部APIは不安定
   - Phase 1では`extern "C"`のみ使用
   - Phase 2でLLVM IR統合を検討

## パフォーマンス

### 現在の実装

- **コンパイル**: 各`rust""`呼び出しでrustcを実行（キャッシュなし）
- **関数呼び出し**: `ccall`経由（標準的なFFIオーバーヘッド）
- **型推論**: 実行時（コンパイル時ではない）

### 最適化の機会

1. **コンパイルキャッシング**
   - [ ] コードハッシュベースのキャッシュ
   - [ ] 永続化キャッシュ（ディスク保存）

2. **型推論の改善**
   - [ ] LLVM IR分析による型推論
   - [ ] コンパイル時の型確定

3. **Phase 2での改善**
   - [ ] `llvmcall`によるインライン化
   - [ ] LLVM最適化パスの適用

## 次のステップ

### 短期（Phase 1 完了）

1. **`@irust`の改善**（優先度: 中）
   - Julia変数の自動バインディング
   - より良いエラーメッセージ

2. **文字列型のサポート**（優先度: 高）✅
   - C文字列入力のサポート完了
   - Julia String引数の自動変換完了
   - 注: Rust String戻り値のメモリ管理は今後の課題

3. **エラーハンドリングの強化**（優先度: 中）
   - `Result<T, E>`から例外への自動変換
   - 詳細なエラーメッセージ

### 中期（Phase 2 準備）

1. **LLVM IR統合の本格化**
   - `llvmcall`への直接埋め込み
   - 最適化パスの適用

2. **所有権型のサポート**
   - `Box<T>`, `Rc<T>`, `Arc<T>`
   - メモリ管理の統合

### 長期（Phase 2+）

1. **ジェネリクス対応**
2. **Lifetimeの基本サポート**
3. **Traitの基本サポート**

## 技術的メモ

### 実装上の重要な決定

1. **ccallの型タプル問題**
   - 問題: `ccall`はリテラル型タプルを要求
   - 解決: 型ごとに専用関数を定義（`_call_rust_i32_0`, `_call_rust_i32_1`等）
   - 影響: 引数の数と型の組み合わせごとに関数が必要

2. **`@irust`の実装アプローチ**
   - Phase 1では簡易実装（引数を明示的に渡す）
   - Phase 2で`@generated`関数による改善を検討

3. **LLVM IR統合**
   - 現在は分析目的のみ使用
   - Phase 2で`llvmcall`埋め込みを実装予定

### 参考実装

- **Cxx.jl**: `llvmcall`のポインタ形式を使用
- **CxxWrap.jl**: より現代的なアプローチ（参考）

## 変更履歴

### 2025-01（文字列型サポート追加）

- ✅ 文字列型（`*const u8`、`Cstring`）のサポート追加
- ✅ `RustString`, `RustStr`型の定義
- ✅ 文字列引数の自動変換（Julia String → Cstring）
- ✅ `UInt32`戻り値型のサポート追加
- ✅ 文字列変換関数の追加
- ✅ テストスイート拡充（60テスト）

### 2025-01（初期実装）

- ✅ プロジェクト構造の作成
- ✅ 基本型システムの実装
- ✅ `rust""`文字列リテラルの実装
- ✅ `@rust`マクロの実装
- ✅ `@irust`マクロの基本実装
- ✅ README.mdの作成
- ✅ テストスイート（45テスト）

## 関連ドキュメント

- [README.md](../README.md) - プロジェクト概要と使用例
- [docs/design/Phase1.md](design/Phase1.md) - Phase 1詳細実装プラン
- [docs/design/Phase2.md](design/Phase2.md) - Phase 2詳細実装プラン
- [docs/design/INTERNAL.md](design/INTERNAL.md) - Cxx.jl内部実装の参考
- [docs/design/LLVMCALL.md](design/LLVMCALL.md) - Julia `llvmcall`の詳細
- [CLAUDE.md](../CLAUDE.md) - 開発ガイド
