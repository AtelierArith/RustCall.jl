# バグ・不具合・解決すべき問題一覧

このドキュメントは、LastCall.jl で現在確認されているバグ、不具合、および解決すべき問題をまとめたものです。

最終更新: 2024年（現在のセッション）

---

## 🔴 重大なバグ（Critical Bugs）

### 1. `@rust` マクロが `@test` コンテキスト内で動作しない

**状態**: 未解決
**優先度**: 高
**影響範囲**: テストスイート

#### 問題の詳細

`@rust` マクロが `@test` マクロ内で使用されると、`UndefVarError` が発生します。

```julia
@testset "test" begin
    rust"""
    #[no_mangle]
    pub extern "C" fn is_positive_tutorial(x: i32) -> bool {
        x > 0
    }
    """

    # これが失敗する
    @test @rust is_positive_tutorial(Int32(5))::Bool == true
    # Error: UndefVarError: `is_positive_tutorial` not defined in `Main`
end
```

#### 再現条件

- `@test` マクロ内で `@rust` を使用
- 関数名が `Main` モジュールで未定義として扱われる

#### 現在の状況

- 直接呼び出し（`@test` なし）では正常に動作
- マクロ展開は正しく生成されている（`"is_positive_tutorial"` が文字列として渡されている）
- `GlobalRef` を使用してモジュール関数を参照するように修正済み
- しかし、`@test` コンテキスト内では依然としてエラーが発生

#### 影響を受けるテスト

- `test/test_docs_examples.jl` の `tutorial.md - Boolean Values` テストセット（2つのテストが失敗）

#### 関連ファイル

- `src/rustmacro.jl` - `@rust` マクロの実装
- `test/test_docs_examples.jl:44-54` - 失敗しているテスト

#### 調査が必要な点

1. `@test` マクロが式を評価する際のマクロ展開の順序
2. `GlobalRef` の解決がテストコンテキストで正しく動作しているか
3. モジュールスコープの問題

---

## 🟡 中程度の問題（Medium Priority Issues）

### 2. Rust helpers ライブラリのビルドが未完成

**状態**: 進行中
**優先度**: 中
**影響範囲**: 所有権型の完全な機能

#### 問題の詳細

`deps/rust_helpers/` の Rust ライブラリがコンパイルされていないため、所有権型（`Box`, `Rc`, `Arc` など）の完全な機能が使用できません。

#### 現在の状況

- ライブラリの構造は完成（`Cargo.toml`, `src/lib.rs`）
- ビルドスクリプト（`deps/build.jl`）が未完成
- 所有権型のテストは、ライブラリが利用可能でない場合はスキップされる

#### 影響

- `RustBox`, `RustRc`, `RustArc` などの所有権型が完全に機能しない
- メモリ管理の統合テストができない

#### 関連ファイル

- `deps/rust_helpers/` - Rust helpers ライブラリ
- `deps/build.jl` - ビルドスクリプト
- `src/memory.jl` - 所有権型の実装

---

### 3. ジェネリクスの trait bounds パースが簡易的

**状態**: 制限事項として認識
**優先度**: 中
**影響範囲**: ジェネリクス機能

#### 問題の詳細

ジェネリクス関数の trait bounds のパースが簡易的で、複雑な境界条件を正しく処理できない可能性があります。

```rust
// これは動作する
pub fn identity<T>(x: T) -> T { x }

// これは正しくパースされない可能性がある
pub fn clone_and_add<T: Clone + Add>(x: T, y: T) -> T {
    x.clone() + y.clone()
}
```

#### 現在の状況

- 基本的な trait bounds はサポートされている
- 複数の trait bounds（`T: Clone + Add`）の処理が簡易的
- 関連型（Associated Types）は未サポート

#### 関連ファイル

- `src/generics.jl` - ジェネリクス機能の実装
- `src/ruststr.jl:222-258` - ジェネリクス関数の検出

---

### 4. キャッシュシステムの並列コンパイル時のロック機構未実装

**状態**: 未実装
**優先度**: 中
**影響範囲**: 並列実行時のキャッシュ整合性

#### 問題の詳細

複数のプロセスが同時に同じ Rust コードをコンパイルしようとした場合、キャッシュの整合性が保証されません。

#### 現在の状況

- 基本的なキャッシュ機能は実装済み
- 並列実行時のロック機構が未実装
- 同じコードを複数のプロセスが同時にコンパイルすると、重複コンパイルが発生する可能性

#### 影響

- 並列テスト実行時に無駄なコンパイルが発生する可能性
- キャッシュの破損リスク（低いが存在）

#### 関連ファイル

- `src/cache.jl` - キャッシュシステムの実装

---

## 🟢 軽微な問題・改善点（Low Priority / Enhancements）

### 5. `@irust` マクロの `$var` 構文が未実装

**状態**: 制限事項として認識
**優先度**: 低
**影響範囲**: `@irust` マクロの使いやすさ

#### 問題の詳細

`@irust` マクロで Julia 変数を自動的にバインディングする `$var` 構文が未実装です。現在は明示的に引数として渡す必要があります。

```julia
# 現在の実装（動作する）
@irust("arg1 * 2", x)

# 理想的な構文（未実装）
@irust("$x * 2")
```

#### 現在の状況

- 基本的な `@irust` 機能は動作する
- `$var` 構文のパースは部分的に実装されているが、完全ではない

#### 関連ファイル

- `src/ruststr.jl:422-514` - `@irust` マクロの実装

---

### 6. API ドキュメントの充実が必要

**状態**: 改善の余地あり
**優先度**: 低
**影響範囲**: 開発者体験

#### 問題の詳細

一部の関数の DocString が不足しているか、詳細が不十分です。

#### 現在の状況

- 主要な関数には DocString が存在
- 一部の内部関数のドキュメントが不足
- 使用例が不足している関数がある

---

### 7. エラーメッセージの改善の余地

**状態**: 改善の余地あり
**優先度**: 低
**影響範囲**: デバッグ体験

#### 問題の詳細

一部のエラーメッセージが技術的すぎて、初心者には理解しにくい可能性があります。

#### 現在の状況

- 基本的なエラーハンドリングは実装済み
- コンパイルエラーの詳細表示は実装済み
- より親しみやすいエラーメッセージへの改善の余地あり

#### 関連ファイル

- `src/exceptions.jl` - エラーハンドリングの実装

---

## 📋 技術的負債（Technical Debt）

### 8. コードの重複

一部の機能でコードの重複が見られます：

- コンパイル処理（`compile_rust_to_shared_lib`, `compile_rust_to_llvm_ir`）で類似のコードが繰り返されている
- エラーハンドリングのパターンが複数の場所で重複

### 9. テストカバレッジ

- エッジケースのテストが不足している可能性
- エラーケースのテストが一部不足

---

## 🔍 調査が必要な問題

### 10. `@rust` マクロの `@test` コンテキスト問題の根本原因

**状態**: 調査中
**優先度**: 高

#### 調査項目

1. `@test` マクロが式を評価する際のマクロ展開の順序
2. `GlobalRef` の解決がテストコンテキストで正しく動作しているか
3. モジュールスコープの問題
4. Julia のマクロ展開とテストフレームワークの相互作用

#### 関連情報

- マクロ展開は正しく生成されている（`"is_positive_tutorial"` が文字列として渡されている）
- 直接呼び出しでは正常に動作
- `@test` コンテキスト内でのみエラーが発生

---

## 📝 解決済みの問題

### ✅ `@rust` マクロのモジュール参照問題（部分的に解決）

**解決日**: 現在のセッション
**状態**: 部分的に解決（`@test` コンテキスト問題は残存）

#### 解決内容

- `GlobalRef` を使用してモジュール関数を参照するように修正
- 文字列を直接 `Expr` に埋め込む方式に変更
- 直接呼び出しでは正常に動作するようになった

#### 残存する問題

- `@test` コンテキスト内での動作は未解決

---

## 🎯 優先度別の対応方針

### 即座に対応すべき（P0）

1. **`@rust` マクロの `@test` コンテキスト問題** (#1)
   - テストスイートが完全に動作しない
   - 開発・CI に直接影響

### 短期対応（P1）

2. **Rust helpers ライブラリのビルド完成** (#2)
   - 所有権型の完全な機能に必要
   - ドキュメントの例が動作するようになる

### 中期対応（P2）

3. **ジェネリクスの trait bounds パース改善** (#3)
   - より複雑なジェネリクス関数をサポート
4. **キャッシュシステムの並列ロック機構** (#4)
   - 並列実行時の効率向上

### 長期対応（P3）

5. **`@irust` マクロの `$var` 構文実装** (#5)
6. **API ドキュメントの充実** (#6)
7. **エラーメッセージの改善** (#7)

---

## 📚 関連ドキュメント

- `docs/STATUS.md` - プロジェクトの全体的な状態
- `docs/src/troubleshooting.md` - トラブルシューティングガイド
- `README.md` - プロジェクトの概要と制限事項

---

## 🔄 更新履歴

- 2024年（現在のセッション）: 初版作成、`@rust` マクロの `@test` コンテキスト問題を追加
